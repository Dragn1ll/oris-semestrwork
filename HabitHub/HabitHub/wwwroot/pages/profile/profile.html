<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>HabitHub ‚Äî –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</title>
    <style>
        body {
            background-color: #111;
            color: #FFD700;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }

        .profile-info {
            margin-left: 20px;
        }

        .profile-name {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .profile-stats {
            display: flex;
            margin: 15px 0;
        }

        .stat-item {
            margin-right: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.9em;
            color: #aaa;
        }

        #profile-actions {
            margin: 20px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        #profile-actions button {
            flex: 1;
            min-width: 200px;
        }

        button {
            border-radius: 12px;
            background-color: #FFD700;
            border: none;
            color: #111;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #e6c200;
        }

        button:disabled {
            background-color: #555;
            color: #999;
            cursor: not-allowed;
        }

        button.delete {
            background-color: #b22222;
            color: white;
        }

        button.delete:hover {
            background-color: #8b0000;
        }

        .post-item {
            background-color: #222;
            border: 1px solid #FFD700;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            position: relative;
        }

        .post-header {
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }

        .post-text {
            margin-bottom: 10px;
        }

        .post-media {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .post-media img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 5px;
        }

        .post-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .post-actions button {
            padding: 5px 10px;
            font-size: 0.9em;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #222;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            border: 2px solid #FFD700;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .close-modal {
            background: none;
            border: none;
            color: #FFD700;
            font-size: 1.5em;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
        }

        input, textarea {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #555;
            background-color: #333;
            color: #FFD700;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        #telegram-info {
            background-color: #333;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        #telegram-link {
            color: #2AABEE;
            text-decoration: none;
            font-weight: bold;
        }

        .user-id-display {
            background-color: #333;
            padding: 5px 10px;
            border-radius: 5px;
            font-family: monospace;
            margin: 5px 0;
            word-break: break-all;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            background-color: #4CAF50;
            color: white;
            border-radius: 5px;
            z-index: 2000;
            display: none;
        }

        .comments-container {
            margin-top: 10px;
            padding: 10px;
            background-color: #333;
            border-radius: 8px;
            display: none; /* –°–Ω–∞—á–∞–ª–∞ —Å–∫—Ä—ã—Ç—ã */
        }

        .comments-container ul {
            list-style: none;
            padding: 0;
        }

        .comments-container li {
            padding: 8px;
            border-bottom: 1px solid #555;
            position: relative;
        }

        .comments-container li:last-child {
            border-bottom: none;
        }

        .delete-comment {
            position: absolute;
            right: 5px;
            top: 5px;
            background-color: #b22222;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 2px 6px;
            font-size: 0.8em;
        }

        .comment-section {
            display: flex;
            margin-top: 10px;
        }

        .comment-section input {
            flex-grow: 1;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #222;
            color: #FFD700;
        }

        /* –£–ª—É—á—à–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ–¥–∏–∞ */
        .post-media {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .post-media img, .post-media video {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 5px;
        }

        .post-media audio {
            width: 100%;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="profile-header">
        <div>
            <div class="profile-name" id="profile-name">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div id="profile-birthday"></div>
            <div id="profile-status"></div>
        </div>
    </div>

    <div class="profile-stats">
        <div class="stat-item">
            <div class="stat-value" id="posts-count">0</div>
            <div class="stat-label">–ü–æ—Å—Ç—ã</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="likes-count">0</div>
            <div class="stat-label">–õ–∞–π–∫–∏</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="comments-count">0</div>
            <div class="stat-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</div>
        </div>
    </div>

    <div id="profile-actions"></div>
    <div id="telegram-info" style="display: none;">
        <h3>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Telegram</h3>
        <p>–ß—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:</p>
        <ol>
            <li>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –∫ –Ω–∞—à–µ–º—É –±–æ—Ç—É: <a id="telegram-link" href="https://t.me/habit_hub_bot" target="_blank">@habit_hub_bot</a></li>
            <li>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–º—É –∫–æ–º–∞–Ω–¥—É: <code>/start</code></li>
            <li>–ó–∞—Ç–µ–º –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à ID: <div class="user-id-display" id="telegram-user-id"></div></li>
        </ol>
    </div>

    <h2>–ü–æ—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
    <div id="post-feed"></div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
<div class="modal" id="edit-profile-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h3>
            <button class="close-modal">&times;</button>
        </div>
        <form id="edit-profile-form">
            <div class="form-group">
                <label for="edit-name">–ò–º—è</label>
                <input type="text" id="edit-name" required>
            </div>
            <div class="form-group">
                <label for="edit-surname">–§–∞–º–∏–ª–∏—è</label>
                <input type="text" id="edit-surname" required>
            </div>
            <div class="form-group">
                <label for="edit-patronymic">–û—Ç—á–µ—Å—Ç–≤–æ</label>
                <input type="text" id="edit-patronymic">
            </div>
            <div class="form-group">
                <label for="edit-status">–°—Ç–∞—Ç—É—Å</label>
                <input type="text" id="edit-status">
            </div>
            <div class="form-group">
                <label for="edit-birthday">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                <input type="date" id="edit-birthday" required>
            </div>
            <div class="form-actions">
                <button type="button" class="close-modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<div class="modal" id="add-post-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç</h3>
            <button class="close-modal">&times;</button>
        </div>
        <form id="add-post-form">
            <div class="form-group">
                <label for="post-text">–¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞</label>
                <textarea id="post-text" required></textarea>
            </div>
            <div class="form-group">
                <label for="post-media">–ú–µ–¥–∏–∞—Ñ–∞–π–ª—ã</label>
                <input type="file" id="post-media" multiple>
            </div>
            <div class="form-actions">
                <button type="button" class="close-modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<div class="notification" id="notification"></div>

<script>
    // –û–±—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    const currentUserId = localStorage.getItem('userId');
    const urlParts = window.location.pathname.split('/');
    const profileUserId = urlParts[urlParts.length - 1];
    const container = document.getElementById('post-feed');
    const actionsDiv = document.getElementById('profile-actions');
    const profileName = document.getElementById('profile-name');
    const profileBirthday = document.getElementById('profile-birthday');
    const profileStatus = document.getElementById('profile-status');
    const postsCount = document.getElementById('posts-count');
    const likesCount = document.getElementById('likes-count');
    const commentsCount = document.getElementById('comments-count');
    const telegramInfo = document.getElementById('telegram-info');
    const telegramUserId = document.getElementById('telegram-user-id');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—à –ª–∏ —ç—Ç–æ –ø—Ä–æ—Ñ–∏–ª—å
    const isMyProfile = profileUserId === currentUserId;

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ Telegram
    let telegramInstructionsVisible = false;

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π
    async function fetchWithRetry(url, options = {}, retry = true) {
        const token = localStorage.getItem('jwt');
        options.headers = {
            ...(options.headers || {}),
            'Authorization': `Bearer ${token}`
        };
        options.credentials = 'include';

        // –î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Content-Type
        if (!(options.body instanceof FormData)) {
            if (options.headers) {
                options.headers['Content-Type'] = 'application/json';
            }
        }

        const response = await fetch(url, options);

        if (response.status === 401 && retry) {
            const refresh = await fetch('/api/auth/refresh', {
                method: 'POST',
                credentials: 'include'
            });

            if (!refresh.ok) {
                localStorage.removeItem('jwt');
                window.location.href = '/login';
                return null;
            }

            const data = await refresh.json();
            if (data.token) {
                localStorage.setItem('jwt', data.token);
            }

            return fetchWithRetry(url, options, false);
        }

        return response;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showNotification(message, isSuccess = true) {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.style.backgroundColor = isSuccess ? '#4CAF50' : '#f44336';
        notification.style.display = 'block';

        setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è
    async function loadProfile() {
        try {
            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            const userRes = await fetchWithRetry(`/api/users/get/${profileUserId}`);
            if (!userRes.ok) {
                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            }

            const user = await userRes.json();

            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            profileName.textContent = `${user.surname} ${user.name}`;
            if (user.patronymic) {
                profileName.textContent += ` ${user.patronymic}`;
            }

            profileBirthday.textContent = `–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: ${new Date(user.birthDay).toLocaleDateString()}`;

            if (user.status) {
                profileStatus.textContent = `–°—Ç–∞—Ç—É—Å: ${user.status}`;
            }

            // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
            if (isMyProfile) {
                actionsDiv.innerHTML = `
                        <button id="btn-add-post">–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç</button>
                        <button id="btn-edit-profile">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
                        <button id="btn-delete-profile" class="delete">–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
                        <button id="btn-connect-google">–ü–æ–¥–∫–ª—é—á–∏—Ç—å Google</button>
                        <button id="btn-connect-telegram">–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
                    `;

                document.getElementById('btn-add-post').onclick = () => {
                    document.getElementById('add-post-modal').style.display = 'flex';
                };

                document.getElementById('btn-edit-profile').onclick = () => {
                    document.getElementById('edit-profile-modal').style.display = 'flex';
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É —Ç–µ–∫—É—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                    document.getElementById('edit-name').value = user.name;
                    document.getElementById('edit-surname').value = user.surname;
                    document.getElementById('edit-patronymic').value = user.patronymic || '';
                    document.getElementById('edit-status').value = user.status || '';
                    document.getElementById('edit-birthday').value = user.birthDay;
                };

                document.getElementById('btn-delete-profile').onclick = async () => {
                    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                        const res = await fetchWithRetry('/api/users/delete', {
                            method: 'DELETE'
                        });

                        if (res.ok) {
                            localStorage.clear();
                            window.location.href = '/';
                        } else {
                            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è', false);
                        }
                    }
                };

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å)
                document.getElementById('btn-connect-telegram').onclick = () => {
                    telegramInstructionsVisible = !telegramInstructionsVisible;
                    telegramInfo.style.display = telegramInstructionsVisible ? 'block' : 'none';
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º userId –¥–ª—è Telegram
                    telegramUserId.textContent = currentUserId;
                };

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Google OAuth —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º redirect_uri
                const client = google.accounts.oauth2.initCodeClient({
                    client_id: '319850806378-8oith89dlmvcvths4mk276q9si92rmcl.apps.googleusercontent.com',
                    scope: 'https://www.googleapis.com/auth/fitness.activity.read',
                    ux_mode: 'popup',
                    redirect_uri: 'http://localhost:5000',
                    callback: async (response) => {
                        /*
                         * –í–∞–∂–Ω–æ: Client secret –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å –∫–ª–∏–µ–Ω—Ç–∞!
                         * –ú—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä,
                         * –∞ —Å–µ—Ä–≤–µ—Ä —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç client secret –¥–ª—è –æ–±–º–µ–Ω–∞ –∫–æ–¥–∞ –Ω–∞ —Ç–æ–∫–µ–Ω—ã.
                         */
                        const res = await fetchWithRetry('/api/google/token/add', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                code: response.code
                            }),
                        });

                        if (res.ok) {
                            showNotification('Google –∞–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω!');
                            document.getElementById('btn-connect-google').textContent = 'Google –ø–æ–¥–∫–ª—é—á–µ–Ω ‚úÖ';
                            document.getElementById('btn-connect-google').disabled = true;
                        } else {
                            const error = await res.text();
                            console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Google:', error);
                            showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Google: ' + error, false);
                        }
                    }
                });

                const btnGoogle = document.getElementById('btn-connect-google');
                btnGoogle.onclick = () => client.requestCode();

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Google
                try {
                    const googleRes = await fetchWithRetry('/api/google/token/contains');
                    if (googleRes.ok) {
                        const isConnected = await googleRes.json();
                        if (isConnected) {
                            btnGoogle.textContent = 'Google –ø–æ–¥–∫–ª—é—á–µ–Ω ‚úÖ';
                            btnGoogle.disabled = true;
                        }
                    }
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ Google –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', e);
                }
            } else {
                actionsDiv.innerHTML = `<button id="btn-send-msg">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</button>`;
                document.getElementById('btn-send-msg').onclick = () => {
                    alert('–§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞!');
                };
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            await renderPosts();

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è: ' + error.message, false);
        }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Å—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function renderPosts() {
        container.innerHTML = '';
        let res = await fetchWithRetry(`/api/posts/get/user/${profileUserId}`);
        if (!res?.ok) return;

        const posts = await res.json();
        postsCount.textContent = posts.length;

        let totalLikes = 0;
        let totalComments = 0;

        for (let post of posts) {
            totalLikes += post.likesCount;
            totalComments += post.commentsCount;

            const div = document.createElement('div');
            div.className = 'post-item';

            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–∏–≤—ã—á–∫–µ
            const habitRes = await fetchWithRetry(`/api/habits/get/${post.habitId}`);
            if (!habitRes.ok) continue;

            const habit = await habitRes.json();

            const header = document.createElement('div');
            header.className = 'post-header';
            header.innerHTML = `
                    <div>${habit.goal}</div>
                    <div>${new Date(post.dateTime).toLocaleString()}</div>
                `;

            const text = document.createElement('div');
            text.className = 'post-text';
            text.textContent = post.text;

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –º–µ–¥–∏–∞—Ñ–∞–π–ª—ã —Å—Ä–∞–∑—É
            const mediaDiv = document.createElement('div');
            mediaDiv.className = 'post-media';
            post.mediaFilesUrl.forEach(url => {
                const ext = url.split('.').pop().toLowerCase();
                let mediaElement;

                if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
                    mediaElement = document.createElement('img');
                    mediaElement.src = url;
                } else if (['mp4', 'webm'].includes(ext)) {
                    mediaElement = document.createElement('video');
                    mediaElement.src = url;
                    mediaElement.controls = true;
                    mediaElement.style.maxWidth = '100%';
                } else if (['mp3', 'wav', 'ogg'].includes(ext)) {
                    mediaElement = document.createElement('audio');
                    mediaElement.src = url;
                    mediaElement.controls = true;
                } else {
                    mediaElement = document.createElement('a');
                    mediaElement.href = url;
                    mediaElement.target = '_blank';
                    mediaElement.textContent = '–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª';
                    mediaElement.style.color = '#f0d000';
                }

                mediaDiv.appendChild(mediaElement);
            });

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'post-actions';

            const likeBtn = document.createElement('button');
            likeBtn.textContent = `${post.didUserLiked ? '‚ù§Ô∏è' : 'ü§ç'} ${post.likesCount}`;
            likeBtn.onclick = async () => {
                const method = post.didUserLiked ? 'DELETE' : 'POST';
                const endpoint = `/api/posts/${post.didUserLiked ? 'delete' : 'add'}/${post.id}/like`;
                const res = await fetchWithRetry(endpoint, { method });

                if (res.ok) {
                    post.didUserLiked = !post.didUserLiked;
                    post.likesCount += post.didUserLiked ? 1 : -1;
                    likeBtn.textContent = `${post.didUserLiked ? '‚ù§Ô∏è' : 'ü§ç'} ${post.likesCount}`;
                    likesCount.textContent = parseInt(likesCount.textContent) + (post.didUserLiked ? 1 : -1);
                }
            };

            const commentsBtn = document.createElement('button');
            commentsBtn.textContent = `üí¨ ${post.commentsCount}`;

            // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
            const commentsContainer = document.createElement('div');
            commentsContainer.className = 'comments-container';

            // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏
            commentsBtn.onclick = async () => {
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å
                commentsContainer.style.display =
                    commentsContainer.style.display === 'block' ? 'none' : 'block';

                // –ï—Å–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
                if (commentsContainer.innerHTML === '' &&
                    commentsContainer.style.display === 'block') {
                    await loadComments(post.id, commentsContainer);
                }
            };

            if (isMyProfile) {
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å';
                deleteBtn.className = 'delete';
                deleteBtn.onclick = async () => {
                    if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?')) {
                        const res = await fetchWithRetry(`/api/posts/delete/${post.id}`, {
                            method: 'DELETE'
                        });

                        if (res.ok) {
                            div.remove();
                            postsCount.textContent = parseInt(postsCount.textContent) - 1;
                            likesCount.textContent = parseInt(likesCount.textContent) - post.likesCount;
                            commentsCount.textContent = parseInt(commentsCount.textContent) - post.commentsCount;
                        }
                    }
                };
                actionsDiv.appendChild(deleteBtn);
            }

            actionsDiv.append(likeBtn, commentsBtn);
            div.append(header, text, mediaDiv, actionsDiv, commentsContainer);
            container.appendChild(div);
        }

        likesCount.textContent = totalLikes;
        commentsCount.textContent = totalComments;
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –¥–ª—è –ø–æ—Å—Ç–∞
    async function loadComments(postId, container) {
        try {
            const res = await fetchWithRetry(`/api/posts/get/${postId}/comments`);
            if (!res.ok) {
                container.innerHTML = '<p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</p>';
                return;
            }

            const comments = await res.json();
            container.innerHTML = '';

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö
            const userIds = [...new Set(comments.map(c => c.userId))];
            const usersMap = {};

            await Promise.all(userIds.map(async id => {
                const userRes = await fetchWithRetry(`/api/users/get/${id}`);
                if (userRes.ok) {
                    usersMap[id] = await userRes.json();
                }
            }));

            // –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
            const ul = document.createElement('ul');
            comments.forEach(comment => {
                const li = document.createElement('li');
                const user = usersMap[comment.userId];
                const userName = user ? `${user.surname} ${user.name}` : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';

                li.innerHTML = `
                        <strong>${userName}:</strong> 
                        <span>${comment.text}</span>
                        <small>${new Date(comment.dateTime).toLocaleString()}</small>
                    `;

                // –ï—Å–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
                if (comment.userId === currentUserId) {
                    const delBtn = document.createElement('button');
                    delBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
                    delBtn.className = 'delete-comment';
                    delBtn.onclick = async () => {
                        const res = await fetchWithRetry(`/api/posts/delete/comment/${comment.id}`, {
                            method: 'DELETE'
                        });

                        if (res.ok) {
                            li.remove();
                            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                            const commentsBtn = container.previousElementSibling.querySelector('button:nth-child(2)');
                            const count = parseInt(commentsBtn.textContent.match(/\d+/)[0]) - 1;
                            commentsBtn.textContent = `üí¨ ${count}`;
                            commentsCount.textContent = parseInt(commentsCount.textContent) - 1;
                        }
                    };
                    li.appendChild(delBtn);
                }

                ul.appendChild(li);
            });

            container.appendChild(ul);

            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
            if (currentUserId) {
                const commentInputDiv = document.createElement('div');
                commentInputDiv.className = 'comment-section';

                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = '–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...';

                const sendBtn = document.createElement('button');
                sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
                sendBtn.onclick = async () => {
                    if (!input.value.trim()) return;

                    const res = await fetchWithRetry(`/api/posts/add/${postId}/comment`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ comment: input.value })
                    });

                    if (res.ok) {
                        input.value = '';
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                        await loadComments(postId, container);

                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                        const commentsBtn = container.previousElementSibling.querySelector('button:nth-child(2)');
                        const count = parseInt(commentsBtn.textContent.match(/\d+/)[0]) + 1;
                        commentsBtn.textContent = `üí¨ ${count}`;
                        commentsCount.textContent = parseInt(commentsCount.textContent) + 1;
                    }
                };

                commentInputDiv.append(input, sendBtn);
                container.appendChild(commentInputDiv);
            }

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:', error);
            container.innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</p>';
        }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
    document.querySelectorAll('.close-modal').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        };
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
    document.getElementById('edit-profile-form').onsubmit = async (e) => {
        e.preventDefault();

        const updatedUser = {
            id: profileUserId,
            name: document.getElementById('edit-name').value,
            surname: document.getElementById('edit-surname').value,
            patronymic: document.getElementById('edit-patronymic').value || null,
            status: document.getElementById('edit-status').value || null,
            birthDay: document.getElementById('edit-birthday').value
        };

        const res = await fetchWithRetry('/api/users/put', {
            method: 'PUT',
            body: JSON.stringify(updatedUser)
        });

        if (res.ok) {
            showNotification('–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
            loadProfile(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
            document.getElementById('edit-profile-modal').style.display = 'none';
        } else {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è', false);
        }
    };

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞
    document.getElementById('add-post-form').onsubmit = async (e) => {
        e.preventDefault();

        const formData = new FormData();
        formData.append('UserId', currentUserId);
        formData.append('Text', document.getElementById('post-text').value);

        // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∏–≤—ã—á–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è –¥–µ–º–æ - –ø–µ—Ä–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞)
        const habitsRes = await fetchWithRetry('/api/habits/get/all');
        if (!habitsRes.ok) {
            showNotification('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∏–≤—ã—á–µ–∫', false);
            return;
        }

        const habits = await habitsRes.json();
        if (habits.length === 0) {
            showNotification('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–∏–≤—ã—á–∫—É!', false);
            return;
        }

        formData.append('HabitId', habits[0].id);

        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã
        const files = document.getElementById('post-media').files;
        for (let i = 0; i < files.length; i++) {
            formData.append('MediaFiles', files[i]);
        }

        const res = await fetchWithRetry('/api/posts/add', {
            method: 'POST',
            body: formData
        });

        if (res.ok) {
            showNotification('–ü–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
            document.getElementById('add-post-modal').style.display = 'none';
            document.getElementById('add-post-form').reset();
            await renderPosts(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–æ–≤
        } else {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ—Å—Ç–∞', false);
        }
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', () => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ—Ñ–∏–ª—è
        if (window.location.pathname.startsWith('/profile/')) {
            loadProfile();
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
        window.onclick = (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        };
    });
</script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
</body>
</html>